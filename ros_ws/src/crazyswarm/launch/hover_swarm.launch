<?xml version="1.0"?>
<launch>
  <arg name="joy_dev" default="/dev/input/js0" />

  <arg name="image_width" default="640" />
  <arg name="image_height" default="480" />
  <arg name="framerate" default="60" />
  <arg name="video_device" default="/dev/video0" />
  <arg name="tag_family" default="25h9" />

  <rosparam command="load" file="$(find crazyswarm)/launch/crazyflies.yaml" />


  <node pkg="crazyflie_driver" type="crazyflie_server" name="crazyflie_server" output="screen">
    <rosparam>
      broadcast_address: "FFE7E7E7E7"
      #broadcast_uri: "radio://0/100/2M/FFE7E7E7E7"
      world_frame: "/world"
      genericLogTopics: ["log1"]
      genericLogTopicFrequencies: [10]
      # genericLogTopic_log1_Variables: ["ekfprof.usec_setup", "ekfprof.usec_innov", "ekfprof.usec_gain", "ekfprof.usec_corr", "ekfprof.usec_cov"]
      # genericLogTopic_log1_Variables: ["profiling.usec_ekf", "profiling.usec_traj", "profiling.usec_ctrl", "profiling.usec_idle"]
      # genericLogTopic_log1_Variables: ["stabilizer.x", "ctrltarget.x", "vicon.x", "stabilizer.z", "ctrltarget.z", "vicon.z"]
      genericLogTopic_log1_Variables: ["stabilizer.x", "vicon.x", "ctrltarget.x"]
      firmwareParams:
        flightmode:
          posCtrl: 1
        ctrlMel:
          kp_xy: 0.4 # p for position
          kd_xy: 0.33 # d for position
          ki_xy: 0.05
          i_range_xy: 2.0
          kR_xy: 70000 # p for attitude
          kw_xy: 20000 # d for attitude
          kR_z: 60000 # p for yaw
          kw_z: 12000  # d for yaw
          ki_m_z: 500     # yaw
          kd_omega_rp: 100 # roll and pitch angular velocity d gain
          i_range_m_z: 1500
          kp_z: 0.8
          kd_z: 0.5
          ki_z: 0.05
          i_range_z: 0.4
          mass: 0.032
          massThrust: 132000
        ring:
          effect: 14 # 6: double spinner, 7: solid color
          solidBlue: 20 # if set to solid color
          solidGreen: 0 # if set to solid color
          solidRed: 0 # if set to solid color
          headlightEnable: 0
      print_latency: False
      write_csvs: True
      force_no_cache: False
      enable_parameters: True
      enable_logging: False
    </rosparam>
  </node>

  <node name="joy" pkg="joy" type="joy_node" output="screen">
    <param name="dev" value="$(arg joy_dev)" />
  </node>

  <node pkg="crazyflie_manager" type="crazyflie_manager" name="crazyflie_manager" output="screen">
    <param name="csv_file" value="$(find crazyswarm)/launch/figure8_smooth.csv" />
    <param name="timescale" value="0.8" />
  </node>


<!--   <node name="vicon" pkg="vicon_ros" type="vicon_node" output="screen">
    <param name="hostName" value="vicon" />
    <param name="enableLatencyTopic" value="true" />
    <param name="enablePointCloudTopic" value="true" />
    <param name="enableTfBroadcast" value="true" />
  </node>

  <node name="object_tracker" pkg="object_tracker" type="object_tracker_node" output="screen">
    <rosparam command="load" file="$(find crazyswarm)/launch/object_tracker.yaml" />
  </node> -->

  <node name="usb_cam" pkg="usb_cam" type="usb_cam_node" output="screen" >
    <param name="video_device" value="$(arg video_device)" />
    <param name="image_width" value="$(arg image_width)" />
    <param name="image_height" value="$(arg image_height)" />
    <param name="pixel_format" value="yuyv" />
    <param name="camera_frame_id" value="usb_cam" />
    <param name="io_method" value="mmap"/>
    <param name="framerate" value="$(arg framerate)" />
  </node>

  <!-- run apriltags detector -->
  <node pkg="apriltags_ros" type="apriltag_detector_node" name="apriltag_detector" output="screen">
    <!-- Remap topic required by the node to custom topics -->
    <remap from="image_rect" to="/usb_cam/image_raw" />
    <remap from="camera_info" to="/usb_cam/camera_info" />

    <!-- Optional: Subscribe to the compressed stream-->
    <param name="image_transport" type="str" value="compressed" />

    <!-- Select the tag family: 16h5, 25h7, 25h9, 36h9, or 36h11(default) -->
    <param name="tag_family" type="str" value="$(arg tag_family)" />

    <!-- Enable projected optical measurements for more accurate tag transformations -->
    <!-- This exists for backwards compatability and should be left true for new setups -->
    <param name="projected_optics" type="bool" value="true" />

    <!-- Describe the tags -->
    <rosparam param="tag_descriptions">
      [
        {id: 0, size: 0.038, frame_id: tag_id_0},
        {id: 1, size: 0.038, frame_id: tag_id_1},
        {id: 2, size: 0.038, frame_id: tag_id_2}
      ]
    </rosparam>
  </node>

  <node pkg="tf" type="static_transform_publisher" name="cam_broadcaster" args="0 0 0 0 0 0 1 /world /usb_cam 10" />

  <node name="rviz" pkg="rviz" type="rviz" args="-d $(find crazyswarm)/launch/test.rviz"/>

  <node pkg="rqt_gui" type="rqt_gui" name="rqt" args="--perspective-file $(find crazyswarm)/launch/rqt.perspective"/>

<!--   <node pkg="rqt_plot" type="rqt_plot" name="rqt_plot_x" args="/cf0A/log1/values[0] /cf0A/log1/values[1] /cf0A/log1/values[2]"/> -->

<!--   <node pkg="rqt_plot" type="rqt_plot" name="rqt_plot_y" args="/cf06/log1/values[3] /cf06/log1/values[4] /cf06/log1/values[5]"/>

  <node pkg="rqt_plot" type="rqt_plot" name="rqt_plot_3" args="/pose/pose/position/x /pose/pose/position/y"/> -->

  <!-- <node pkg="rqt_plot" type="rqt_plot" name="rqt_plot_x" args="/cf05/log1/values[0] /cf05/log1/values[1]"/> -->
  <!-- <node pkg="rqt_plot" type="rqt_plot" name="rqt_plot_y" args="/cf05/log1/values[3] /cf05/log1/values[4] /cf05/log1/values[5]"/> -->
  <!-- <node pkg="rqt_plot" type="rqt_plot" name="rqt_plot_3" args="/cf05/log1/values[4] /cf05/log1/values[5]"/> -->

</launch>
